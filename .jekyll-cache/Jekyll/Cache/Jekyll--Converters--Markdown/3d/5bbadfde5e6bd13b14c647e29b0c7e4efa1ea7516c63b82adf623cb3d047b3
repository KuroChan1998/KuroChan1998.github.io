I"ÿ(<h1 id="ä»æºç è§£æspring-beançš„ç”Ÿå‘½å‘¨æœŸ">ä»æºç è§£æSpring Beançš„ç”Ÿå‘½å‘¨æœŸ</h1>

<p><img src="https://images2015.cnblogs.com/blog/937513/201605/937513-20160507202024015-234747937.png" alt="img" /></p>

<blockquote>
  <p>æ‰«æâ€”â€”è§£æâ€”â€”getBeanâ€”â€”å®ä¾‹åŒ–â€”â€”è‡ªåŠ¨è£…é…â€”â€”life callbackâ€”â€”proxy</p>
</blockquote>

<ol>
  <li>AnnotationConfigApplicationContextè·å–bean.classé…ç½®ï¼Œè°ƒç”¨çˆ¶ç±»GenericApplicationContextçš„æ„é€ å™¨</li>
  <li>GenericBeanDefinition(BeanDefinition)å­˜beançš„ä¿¡æ¯ï¼Œå¯ä»¥é€šè¿‡postProcessBeanFactory(ConfigurableListableBeanFactory beanFactory)æ–¹æ³•ä¿®æ”¹beançš„å±æ€§</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyBeanFactoryPostProcessor</span> <span class="kd">implements</span> <span class="nc">BeanFactoryPostProcessor</span> <span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">postProcessBeanFactory</span><span class="o">(</span><span class="nc">ConfigurableListableBeanFactory</span> <span class="n">beanFactory</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="nc">GenericBeanDefinition</span> <span class="n">beanDefinition</span><span class="o">=</span> <span class="o">(</span><span class="nc">GenericBeanDefinition</span><span class="o">)</span> <span class="n">beanFactory</span><span class="o">.</span><span class="na">getBeanDefinition</span><span class="o">(</span><span class="s">"userDao"</span><span class="o">);</span>
		<span class="n">beanDefinition</span><span class="o">.</span><span class="na">setBeanClass</span><span class="o">(</span><span class="nc">StudentDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ol>
  <li>ç„¶åå°†BeanDefinitionä¸­çš„ä¿¡æ¯put Map</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="cm">/** Map from serialized id to factory instance */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">Map</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">,</span> <span class="nc">Reference</span><span class="o">&lt;</span><span class="nc">DefaultListableBeanFactory</span><span class="o">&gt;&gt;</span> <span class="n">serializableFactories</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ConcurrentHashMap</span><span class="o">&lt;&gt;(</span><span class="mi">8</span><span class="o">);</span>
</code></pre></div></div>

<p><img src="https://github.com/KuroChan1998/KuroChan1998.github.io/blob/master/img/mdimg/Snipaste_2019-09-17_17-54-52.jpg" alt="Snipaste_2019-09-17_17-54-52" /></p>

<ol>
  <li>å¼€å§‹å®ä¾‹åŒ–å•ä¾‹å¯¹è±¡è¿‡ç¨‹ï¼š</li>
</ol>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>				<span class="c1">// Instantiate all remaining (non-lazy-init) singletons.</span>
				<span class="c1">//å®ä¾‹åŒ–å•ä¾‹å¯¹è±¡</span>
				<span class="n">finishBeanFactoryInitialization</span><span class="o">(</span><span class="n">beanFactory</span><span class="o">);</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="c1">// Instantiate all remaining (non-lazy-init) singletons.</span>
        <span class="c1">//å®ä¾‹åŒ–æ‰€æœ‰å•ä¾‹å¯¹è±¡</span>
        <span class="n">beanFactory</span><span class="o">.</span><span class="na">preInstantiateSingletons</span><span class="o">();</span>
</code></pre></div></div>

<p>getBean(beanName);</p>

<p>è°ƒç”¨doGetBean( );</p>

<p>å…¶ä¸­singletonObjectsè¿™ä¸ªMapç±»å‹å°±æ˜¯<strong>æ‰€è°“çš„beanå®¹å™¨</strong>ï¼ï¼ï¼ï¼å®ƒä¹Ÿå¯ä»¥ç§°ä½œ<strong>å•ä¾‹æ± </strong></p>

<p><img src="https://github.com/KuroChan1998/KuroChan1998.github.io/blob/master/img/mdimg/Snipaste_2019-09-17_22-07-59.jpg" alt="Snipaste_2019-09-17_22-07-59" /></p>

<p>â€‹	åœ¨åˆå§‹åŒ–é…ç½®çš„æ—¶å€™å°±åœ¨æ± ä¸­åˆ›é€ è¿™ä¸ªbeanï¼Œå†getBeançš„æ—¶å€™ç›´æ¥è°ƒç”¨getSingleton()ä»æ± ä¸­å–ï¼ˆç¬¬ä¸€æ¬¡è°ƒç”¨ï¼‰</p>

<p><img src="https://github.com/KuroChan1998/KuroChan1998.github.io/blob/master/img/mdimg/Snipaste_2019-09-17_22-35-38.jpg" alt="Snipaste_2019-09-17_22-35-38" /></p>

<p>doGetBeanæ–¹æ³•ä¸­ç¬¬äºŒæ¬¡è°ƒç”¨getSingleton()</p>

<p><img src="https://github.com/KuroChan1998/KuroChan1998.github.io/blob/master/img/mdimg/Snipaste_2019-09-17_22-35-38.jpg" alt="Snipaste_2019-09-17_22-35-38" /></p>

<ol>
  <li>
    <p>Initialization callbacks</p>

    <p>initializeBean()æ–¹æ³•ä¸­å®Œæˆ</p>

    <p><img src="https://github.com/KuroChan1998/KuroChan1998.github.io/blob/master/img/mdimg/Snipaste_2019-09-18_13-44-44.jpg" alt="Snipaste_2019-09-18_13-44-44" /></p>
  </li>
</ol>

<ul>
  <li>
    <p>@PostConstructï¼ˆå…ˆï¼‰</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="nd">@PostConstruct</span>
	<span class="kd">public</span> <span class="kt">void</span>  <span class="nf">init</span><span class="o">(){</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"life callback"</span><span class="o">);</span>
	<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>init-method=â€initâ€</p>

    <div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"exampleInitBean"</span> <span class="na">class=</span><span class="s">"examples.ExampleBean"</span> <span class="na">init-method=</span><span class="s">"init"</span><span class="nt">/&gt;</span>
</code></pre></div>    </div>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ExampleBean</span> <span class="o">{</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">init</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// do some initialization work</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>implements InitializingBeanï¼ˆåï¼‰</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">AnotherExampleBean</span> <span class="kd">implements</span> <span class="nc">InitializingBean</span> <span class="o">{</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">afterPropertiesSet</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// do some initialization work</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ul>

<ol>
  <li>
    <p>BeanPostProcessoråç½®å¤„ç†å™¨ï¼ˆåœ¨springbeanåˆå§‹åŒ–è¿‡ç¨‹ä¸­å…±æœ‰9ä¸ªï¼å¦‚resolveBeforeInstantiationï¼‰</p>

    <p>å¾ªç¯ ä¾èµ–è§£å†³ä¹Ÿæ˜¯é€šè¿‡åç½®å¤„ç†å™¨å®Œæˆçš„</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyBeanPostProcessor</span> <span class="kd">implements</span> <span class="nc">BeanPostProcessor</span> <span class="o">{</span>
	<span class="cm">/**
	 * Initialization callbackså‰è°ƒç”¨ï¼Œè¿™æ˜¯ç¬¬ä¸ƒä¸ªåç½®å¤„ç†å™¨
	 **/</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">postProcessBeforeInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"userDao"</span><span class="o">)){</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">beanName</span><span class="o">+</span><span class="s">" postProcessBeforeInitialization"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
	<span class="o">}</span>
   
	<span class="cm">/**
	 * Initialization callbacksåè°ƒç”¨ï¼Œè¿™æ˜¯ç¬¬å…«æ¬¡è°ƒç”¨å¤„ç†å™¨
	 **/</span>
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="nc">Object</span> <span class="nf">postProcessAfterInitialization</span><span class="o">(</span><span class="nc">Object</span> <span class="n">bean</span><span class="o">,</span> <span class="nc">String</span> <span class="n">beanName</span><span class="o">)</span> <span class="kd">throws</span> <span class="nc">BeansException</span> <span class="o">{</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">beanName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">"userDao"</span><span class="o">))</span> <span class="o">{</span>
			<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">beanName</span> <span class="o">+</span> <span class="s">" postProcessAfterInitialization"</span><span class="o">);</span>
		<span class="o">}</span>
		<span class="k">return</span> <span class="n">bean</span><span class="o">;</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>ä½¿ç”¨å§ã€‚ã€‚ã€‚</p>
  </li>
</ol>

:ET